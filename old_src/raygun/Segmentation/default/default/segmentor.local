#!/bin/bash

config_json=`realpath $1`

# venv
segway_dir=/n/groups/htem/Segmentation/shared-nondev/segway2

#$?
# export PYTHONPATH=$PYTHONPATH:/n/groups/htem/Segmentation/tmn7/gunpowder-1.2.2-220114
# export PYTHONPATH=$PYTHONPATH:/n/groups/htem/users/jlr54/gunpowder_jax_triMod
# . /n/groups/htem/users/tmn7/envs/ubuntu18_python36_daisy1/bin/activate
# . /n/groups/htem/users/tmn7/envs/ubuntu20_python39_wk/bin/activate

# . /n/groups/htem/users/tmn7/envs/ubuntu18_python37/bin/activate
# . /n/groups/htem//users/mkn5/venv/daisy-2/bin/activate
if [ "$PYTHONPATH" != */n/groups/htem/Segmentation/shared-nondev* ]; then
    echo INFO: PYTHONPATH env does not have segway... adding it
    export PYTHONPATH=$PYTHONPATH:/n/groups/htem/Segmentation/shared-nondev
fi

#Get most available GPU:
n=0
m=0
m_i=0
for i in $(nvidia-smi --format=csv,noheader,nounits --query-gpu=memory.free)
do
        if ((m_i < i)) ; then
                m_i=$i
                m=$n
        fi
        n=$((n+1))
done
export CUDA_VISIBLE_DEVICES=$m
export TF_FORCE_GPU_ALLOW_GROWTH=true
export XLA_FLAGS=--xla_gpu_strict_conv_algorithm_picker=false

# TODO: Determine if this is necessary
# Remove existing zarr 
if [ -d "${config_json/json/"zarr"}" ]; then
    echo "Removing zarr"
    rm -r "${config_json/json/"zarr"}"
fi

echo ==========Segment==========
# TODO Check for waterz error
python ${segway_dir}/tasks/segmentation/task_06a_extract_segments.py ${config_json}

echo ==========Evaluate==========
python /n/groups/htem/users/jlr54/raygun/Segmentation/rasterize_skeleton.py ${config_json}


echo "All done."
